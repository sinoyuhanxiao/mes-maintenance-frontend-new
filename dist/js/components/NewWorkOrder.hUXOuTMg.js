import"../vue/vue.Dfo81L2Q.js";import{a as Z}from"../vue-router/vue-router.30cuaQZO.js";import{u as K}from"../vue-i18n/vue-i18n.DjO1PVT4.js";import{a as Q,R as se}from"../useWorkOrder/useWorkOrder.9JcLncGa.js";import{B as de}from"../@element-plus/@element-plus.BNeHluFm.js";import{_ as ae,c as X}from"../../assets/index-CE-d1vf_.js";import{am as q,as as ue,c as E,o as g,S as a,O as U,L as n,M as me,K as S,a as O,Q as T,r as V,w as F,_ as Y,j as W,R as $,d as ne,aM as ce,p as ee,q as oe,F as G,a8 as P}from"../@vue/@vue.CVGyaoMH.js";import{u as A}from"../minio/minio.D0rhAIsD.js";import{u as le}from"../commonData/commonData.B4nBUyAw.js";import{c as pe,b as fe,a as _e}from"../equipment/equipment.hEuZPeX-.js";import{u as j}from"../useErrorHandler/useErrorHandler.DVUZjmHi.js";import"../@intlify/@intlify.BhOIvmlS.js";import"../work-order/work-order.DahU_I_M.js";import"../geotiff/geotiff.Dp1pzeXC.js";import"../element-plus/element-plus.CU5xiOkY.js";import"../lodash-es/lodash-es.BLHqGvLj.js";import"../@popperjs/@popperjs.D_chPuIy.js";import"../@ctrl/@ctrl.r5W6hzzQ.js";import"../dayjs/dayjs.C0sY0_St.js";import"../async-validator/async-validator.D3FX-SGt.js";import"../memoize-one/memoize-one.BdPwpGay.js";import"../normalize-wheel-es/normalize-wheel-es.BQoi3Ox2.js";import"../@floating-ui/@floating-ui.85_40PfK.js";import"../pinia/pinia.CzPcBe5J.js";import"../vue-demi/vue-demi.-dVQ4Px2.js";import"../js-cookie/js-cookie.Cz0CWeBA.js";import"../path-to-regexp/path-to-regexp.i8-bKtXe.js";import"../fuse.js/fuse.js.BiDyM4rQ.js";import"../path-browserify/path-browserify.DkEToxTs.js";import"../screenfull/screenfull.DmVOzVZz.js";import"../mitt/mitt.DJ65BbbF.js";import"../@vueuse/@vueuse.B5lT-MN9.js";import"../axios/axios.Dq7h7Pqt.js";import"../nprogress/nprogress._Z8YfKSV.js";/* empty css                                 */import"../clipboard/clipboard.DAe4Lk7l.js";import"../vue3-lottie/vue3-lottie.DS19j_I8.js";import"../lottie-web/lottie-web.fKmgUVyQ.js";import"../common/common.CFlva48m.js";const ge={__name:"Upload",props:{imageList:{type:Array,default:()=>[]},filesList:{type:Array,default:()=>[]}},emits:["update:imageList","update:filesList"],setup(d,{expose:t,emit:b}){t();const e=V([]),I=V(!1),r=V(""),_=V(!1),s=V([]),y=b,h=(u,p)=>{const w=p.map(l=>new Promise(m=>{if(l.uid||(l.uid=Date.now().toString()),!l.raw){m(l);return}const c=new FileReader;c.onload=v=>{l.url=v.target.result,m(l)},c.readAsDataURL(l.raw)}));Promise.all(w).then(l=>{s.value=l})},f=u=>{const p=s.value.findIndex(w=>w.uid===u.uid);p!==-1?(s.value.splice(p,1),s.value=JSON.parse(JSON.stringify(s.value))):console.error("File not found in fileFileList.")},i=u=>{u.url?(r.value=u.url,I.value=!0):console.error("Invalid image URL. Please check the file object:",u)},k=u=>{const p=e.value.findIndex(w=>w.uid===u.uid);p!==-1?(e.value.splice(p,1),e.value=JSON.parse(JSON.stringify(e.value))):console.error("File not found in fileList.")},L=(u,p)=>{const w=p.map(l=>new Promise(m=>{if(l.uid||(l.uid=Date.now().toString()),!l.raw){m(l);return}const c=new FileReader;c.onload=v=>{l.url=v.target.result,m(l)},c.readAsDataURL(l.raw)}));Promise.all(w).then(l=>{e.value=l})},D=u=>{if(u.url){const p=document.createElement("a");p.href=u.url,p.download=u.name||"downloaded_file.png",document.body.appendChild(p),p.click(),document.body.removeChild(p)}else console.error("File URL not available for download.")},o=u=>(_.value=!0,!0);F(e,u=>{const p=u.map(w=>w.raw).filter(w=>w instanceof File);y("update:imageList",p)},{deep:!0}),F(s,u=>{const p=u.map(w=>w.raw).filter(w=>w instanceof File);y("update:filesList",p)},{deep:!0});const R={fileList:e,dialogVisible:I,dialogImageUrl:r,uploading:_,fileFileList:s,emit:y,handleFileChange:h,handleFileRemove:f,handlePictureCardPreview:i,handleRemove:k,handleChange:L,handleDownload:D,handleBeforeUpload:o,ref:V,watch:F,get Plus(){return de}};return Object.defineProperty(R,"__isScriptSetup",{enumerable:!1,value:!0}),R}},he={class:"upload-editor"},we=["src"],ve={class:"el-upload-list__item-actions"},qe=["onClick"],be=["onClick"],ye=["onClick"],ke={class:"image-wrapper"},Ce=["src"];function Ve(d,t,b,e,I,r){const _=q("el-icon"),s=q("ZoomIn"),y=q("Download"),h=q("Delete"),f=q("el-upload"),i=q("el-dialog"),k=q("el-form-item"),L=q("el-button"),D=ue("loading");return g(),E("div",he,[a(k,{label:"图片上传",prop:"upload"},{default:n(()=>[me((g(),S(f,{class:"upload-demo",action:"#","list-type":"picture-card","auto-upload":!1,"on-preview":e.handlePictureCardPreview,"on-remove":e.handleRemove,"file-list":e.fileList,"on-change":e.handleChange,"on-progress":e.handleBeforeUpload,accept:"image/*"},{file:n(({file:o})=>[O("div",null,[O("img",{class:"el-upload-list__item-thumbnail",src:o.url,alt:""},null,8,we),O("span",ve,[O("span",{class:"el-upload-list__item-preview",onClick:R=>e.handlePictureCardPreview(o)},[a(_,null,{default:n(()=>[a(s)]),_:1})],8,qe),O("span",{class:"el-upload-list__item-delete",onClick:R=>e.handleDownload(o)},[a(_,null,{default:n(()=>[a(y)]),_:1})],8,be),O("span",{class:"el-upload-list__item-delete",onClick:R=>e.handleRemove(o)},[a(_,null,{default:n(()=>[a(h)]),_:1})],8,ye)])])]),default:n(()=>[a(_,null,{default:n(()=>[a(e.Plus)]),_:1})]),_:1},8,["file-list"])),[[D,e.uploading]]),a(i,{fullscreen:"",modelValue:e.dialogVisible,"onUpdate:modelValue":t[0]||(t[0]=o=>e.dialogVisible=o),"append-to-body":""},{default:n(()=>[O("div",ke,[O("img",{src:e.dialogImageUrl,alt:"Preview Image"},null,8,Ce)])]),_:1},8,["modelValue"])]),_:1}),U(" 文件上传 Field "),a(k,{label:"文件上传",prop:"upload"},{default:n(()=>[a(f,{class:"upload-demo",action:"#","list-type":"text","auto-upload":!1,"on-remove":e.handleFileRemove,"file-list":e.fileFileList,"on-change":e.handleFileChange,accept:".pdf,.doc,.docx,.xls,.xlsx,.txt,.zip,.rar,.csv,.json,.xml,.ppt,.pptx"},{default:n(()=>[a(L,{size:"small",type:"success"},{default:n(()=>t[1]||(t[1]=[T("点击上传")])),_:1,__:[1]})]),_:1},8,["file-list"])]),_:1})])}const Ie=ae(ge,[["render",Ve],["__scopeId","data-v-139c6b16"],["__file","/home/erikyu/dev/mes-maintenance-frontend/src/views/workOrder/components/Upload.vue"]]);function te(){const{handleAsync:d}=j(),t=V([]),b=V([]),e=V([]),I=Y({equipmentGroups:!1,equipments:!1,components:!1}),r=Y({productionLineId:null,equipmentGroupId:null,equipmentId:null,componentId:null}),_=W(()=>t.value.length>0),s=W(()=>b.value.length>0),y=W(()=>e.value.length>0),h=async l=>{if(!l){t.value=[];return}await d(async()=>{const{data:m}=await _e(l);t.value=m.data||[]},{loadingRef:I.equipmentGroups,context:"fetchEquipmentGroups",customMessage:"Failed to load equipment groups"})},f=async l=>{if(!l){b.value=[];return}await d(async()=>{const{data:m}=await fe(l);b.value=m.data||[]},{loadingRef:I.equipments,context:"fetchEquipments",customMessage:"Failed to load equipments"})},i=async l=>{if(!l){e.value=[];return}await d(async()=>{const{data:m}=await pe(l);e.value=m.data||[]},{loadingRef:I.components,context:"fetchComponents",customMessage:"Failed to load components"})},k=l=>{switch(l){case"productionLine":r.equipmentGroupId=null,r.equipmentId=null,r.componentId=null,t.value=[],b.value=[],e.value=[];break;case"equipmentGroup":r.equipmentId=null,r.componentId=null,b.value=[],e.value=[];break;case"equipment":r.componentId=null,e.value=[];break;default:console.warn(`Invalid level provided to clearDownstreamSelections: ${l}`);break}};return{equipmentGroups:t,equipments:b,components:e,loading:I,selectedValues:r,hasEquipmentGroups:_,hasEquipments:s,hasComponents:y,fetchEquipmentGroups:h,fetchEquipments:f,fetchComponents:i,handleProductionLineChange:async l=>{r.productionLineId=l,k("productionLine"),l&&await h(l)},handleEquipmentGroupChange:async l=>{r.equipmentGroupId=l,k("equipmentGroup"),l&&await f(l)},handleEquipmentChange:async l=>{r.equipmentId=l,k("equipment"),l&&await i(l)},handleComponentChange:l=>{r.componentId=l},resetAll:()=>{r.productionLineId=null,r.equipmentGroupId=null,r.equipmentId=null,r.componentId=null,t.value=[],b.value=[],e.value=[]},setInitialValues:async l=>{const{productionLineId:m,equipmentGroupId:c,equipmentId:v,componentId:x}=l;m&&(r.productionLineId=m,await h(m),c&&(r.equipmentGroupId=c,await f(c),v&&(r.equipmentId=v,await i(v),x&&(r.componentId=x))))},getSelectionPath:l=>{const m=[];if(r.productionLineId){const c=l.productionLines.find(v=>v.id===r.productionLineId);c&&m.push(c.name)}if(r.equipmentGroupId){const c=t.value.find(v=>v.id===r.equipmentGroupId);c&&m.push(c.name)}if(r.equipmentId){const c=b.value.find(v=>v.id===r.equipmentId);c&&m.push(c.name)}if(r.componentId){const c=e.value.find(v=>v.id===r.componentId);c&&m.push(c.name)}return m.join(" > ")}}}const Oe=ne({name:"NewWorkOrder"}),Le=Object.assign(Oe,{props:{requestData:Object,height:String},emits:["cancel"],setup(d,{expose:t,emit:b}){t(),ce(C=>({"6326481b-height":d.height}));const e=d,I=b,r=Z(),{t:_}=K(),s=X(),y=le(),{handleAsync:h,showSuccess:f}=j(),{form:i,rules:k,validateForm:L}=Q();ee(()=>{e.requestData&&(i.name=e.requestData.name,i.description=e.requestData.description,i.request_id=e.requestData.id)});const{equipmentGroups:D,equipments:o,components:R,selectedValues:u,hasEquipmentGroups:p,hasEquipments:w,hasComponents:l,handleProductionLineChange:m,handleEquipmentGroupChange:c,handleEquipmentChange:v,handleComponentChange:x}=te(),B=V(null),N=V(!1),z=async()=>{try{let C=[],H=[];i.image_list.length>0&&(C=(await A(i.image_list)).data.uploadedFiles||[],i.image_list=C.map(M=>M.url)),i.files_list.length>0&&(H=(await A(i.files_list)).data.uploadedFiles||[],i.files_list=H.map(M=>M.url)),f(_("workOrder.messages.uploadSuccess"))}catch(C){throw console.error("❌ File upload failed:",C),new Error(_("workOrder.messages.uploadFailed"))}},re=async()=>{try{if(!await L(B.value))return;N.value=!0,await h(async()=>{await z(),i.production_line_id=u.productionLineId,i.equipment_group_id=u.equipmentGroupId,i.equipment_id=u.equipmentId,i.component_id=u.componentId,f(_("workOrder.messages.createSuccess")),s.DEL_VIEW(r.currentRoute.value),r.push("/workOrder/complex")},{context:"createWorkOrder",customMessage:_("workOrder.messages.createFailed"),loadingRef:N})}catch(C){console.error("❌ Work order creation failed:",C),N.value=!1}};F(()=>i.recurrence_setting,C=>{i.recurrence_type=C.recurrence_type},{deep:!0}),oe(async()=>{try{await Promise.all([y.fetchPriorities(),y.fetchWorkTypes(),y.fetchCategories()])}catch(C){console.error("Failed to initialize form data:",C)}});const J={props:e,emit:I,router:r,t:_,tagsViewStore:s,commonDataStore:y,handleAsync:h,showSuccess:f,form:i,rules:k,validateForm:L,equipmentGroups:D,equipments:o,components:R,selectedValues:u,hasEquipmentGroups:p,hasEquipments:w,hasComponents:l,handleProductionLineChange:m,handleEquipmentGroupChange:c,handleEquipmentChange:v,handleComponentChange:x,formRef:B,loading:N,uploadFilesToServer:z,submitForm:re,__MACROS_defineComponent:ne,ref:V,watch:F,onMounted:oe,watchEffect:ee,get useRouter(){return Z},get useI18n(){return K},RecurrenceEditor:se,UploadEditor:Ie,get uploadMultipleToMinio(){return A},get useTagsViewStore(){return X},get useCommonDataStore(){return le},get useWorkOrderForm(){return Q},get useEquipment(){return te},get useErrorHandler(){return j}};return Object.defineProperty(J,"__isScriptSetup",{enumerable:!1,value:!0}),J}}),Se={class:"new-work-order"},Ee={class:"equipment"},De={class:"categorization"};function Re(d,t,b,e,I,r){const _=q("el-input"),s=q("el-form-item"),y=q("el-switch"),h=q("el-option"),f=q("el-select"),i=q("el-col"),k=q("el-row"),L=q("el-button"),D=q("el-form");return g(),E("div",Se,[O("h1",null,$(d.$t("workOrder.newWorkOrder")),1),a(D,{ref:"formRef",model:e.form,rules:e.rules,"label-width":"150px",class:"work-order-form"},{default:n(()=>[e.props.requestData?(g(),S(s,{key:0,label:"Request ID",prop:"request_id",required:"","show-message":!1},{default:n(()=>[a(_,{modelValue:e.form.request_id,"onUpdate:modelValue":t[0]||(t[0]=o=>e.form.request_id=o),disabled:""},null,8,["modelValue"])]),_:1})):U("v-if",!0),U(" Work Order Name and Description "),a(s,{label:d.$t("workOrder.form.name"),prop:"name",required:"","show-message":!1},{default:n(()=>[a(_,{modelValue:e.form.name,"onUpdate:modelValue":t[1]||(t[1]=o=>e.form.name=o),placeholder:d.$t("workOrder.placeholder.workOrderName"),clearable:""},null,8,["modelValue","placeholder"])]),_:1},8,["label"]),a(s,{label:d.$t("workOrder.form.description")},{default:n(()=>[a(_,{modelValue:e.form.description,"onUpdate:modelValue":t[2]||(t[2]=o=>e.form.description=o),type:"textarea",placeholder:d.$t("workOrder.placeholder.description"),style:{width:"500px"},clearable:""},null,8,["modelValue","placeholder"])]),_:1},8,["label"]),a(s,{label:d.$t("workOrder.form.haltType"),required:""},{default:n(()=>[a(y,{modelValue:e.form.halt_type,"onUpdate:modelValue":t[3]||(t[3]=o=>e.form.halt_type=o),"active-value":1,"inactive-value":0,"inline-prompt":"","active-text":d.$t("common.yes"),"inactive-text":d.$t("common.no"),style:{"--el-switch-on-color":"#f65650",width:"70px"}},null,8,["modelValue","active-text","inactive-text"])]),_:1},8,["label"]),U(" Equipment Selection "),O("div",Ee,[a(s,{label:d.$t("workOrder.form.assets"),required:""},{default:n(()=>[a(k,{gutter:"5"},{default:n(()=>[a(i,{span:20},{default:n(()=>[a(s,{label:"",class:"form-item",prop:"production_line_id","show-message":!1,required:""},{default:n(()=>[a(f,{class:"equipment-fields",modelValue:e.selectedValues.productionLineId,"onUpdate:modelValue":t[4]||(t[4]=o=>e.selectedValues.productionLineId=o),placeholder:d.$t("workOrder.form.productionLine"),clearable:"",onChange:e.handleProductionLineChange},{default:n(()=>[(g(!0),E(G,null,P(e.commonDataStore.productionLines,o=>(g(),S(h,{key:o.id,label:o.name,value:o.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","placeholder","onChange"])]),_:1})]),_:1}),a(i,{span:20},{default:n(()=>[a(s,{label:"",class:"form-item"},{default:n(()=>[a(f,{class:"equipment-fields",modelValue:e.selectedValues.equipmentGroupId,"onUpdate:modelValue":t[5]||(t[5]=o=>e.selectedValues.equipmentGroupId=o),placeholder:d.$t("workOrder.form.equipmentGroup"),clearable:"",disabled:!e.hasEquipmentGroups,onChange:e.handleEquipmentGroupChange},{default:n(()=>[(g(!0),E(G,null,P(e.equipmentGroups,o=>(g(),S(h,{key:o.id,label:o.name,value:o.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","placeholder","disabled","onChange"])]),_:1})]),_:1}),a(i,{span:20},{default:n(()=>[a(s,{label:"",class:"form-item"},{default:n(()=>[a(f,{class:"equipment-fields",modelValue:e.selectedValues.equipmentId,"onUpdate:modelValue":t[6]||(t[6]=o=>e.selectedValues.equipmentId=o),placeholder:d.$t("workOrder.form.equipment"),clearable:"",disabled:!e.hasEquipments,onChange:e.handleEquipmentChange},{default:n(()=>[(g(!0),E(G,null,P(e.equipments,o=>(g(),S(h,{key:o.id,label:o.name,value:o.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","placeholder","disabled","onChange"])]),_:1})]),_:1}),a(i,{span:20},{default:n(()=>[a(s,{label:"",class:"form-item"},{default:n(()=>[a(f,{class:"equipment-fields",modelValue:e.selectedValues.componentId,"onUpdate:modelValue":t[7]||(t[7]=o=>e.selectedValues.componentId=o),placeholder:d.$t("workOrder.form.component"),clearable:"",disabled:!e.hasComponents,onChange:e.handleComponentChange},{default:n(()=>[(g(!0),E(G,null,P(e.components,o=>(g(),S(h,{key:o.id,label:o.name,value:o.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","placeholder","disabled","onChange"])]),_:1})]),_:1})]),_:1})]),_:1},8,["label"])]),U(" Classification Section "),O("div",De,[a(s,{label:d.$t("workOrder.form.classification"),required:""},{default:n(()=>[a(i,{span:20},{default:n(()=>[a(s,{label:"",class:"form-item",prop:"priority_id","show-message":!1},{default:n(()=>[a(f,{modelValue:e.form.priority_id,"onUpdate:modelValue":t[8]||(t[8]=o=>e.form.priority_id=o),placeholder:d.$t("workOrder.placeholder.selectPriority"),clearable:""},{default:n(()=>[(g(!0),E(G,null,P(e.commonDataStore.priorities,o=>(g(),S(h,{key:o.id,label:o.name,value:o.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","placeholder"])]),_:1})]),_:1}),a(i,{span:20},{default:n(()=>[a(s,{label:"",class:"form-item",prop:"category_id","show-message":!1},{default:n(()=>[a(f,{modelValue:e.form.category_id,"onUpdate:modelValue":t[9]||(t[9]=o=>e.form.category_id=o),placeholder:d.$t("workOrder.placeholder.selectCategory"),clearable:""},{default:n(()=>[(g(!0),E(G,null,P(e.commonDataStore.categories,o=>(g(),S(h,{key:o.id,label:o.name,value:o.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","placeholder"])]),_:1})]),_:1}),a(i,{span:20},{default:n(()=>[a(s,{label:"",class:"form-item",prop:"work_type_id","show-message":!1},{default:n(()=>[a(f,{modelValue:e.form.work_type_id,"onUpdate:modelValue":t[10]||(t[10]=o=>e.form.work_type_id=o),placeholder:d.$t("workOrder.placeholder.selectWorkType"),clearable:""},{default:n(()=>[(g(!0),E(G,null,P(e.commonDataStore.workTypes,o=>(g(),S(h,{key:o.id,label:o.name,value:o.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","placeholder"])]),_:1})]),_:1})]),_:1},8,["label"])]),U(" Recurrence and Upload Sections "),a(e.RecurrenceEditor,{"recurrence-setting":e.form.recurrence_setting,"onUpdate:recurrenceSetting":t[11]||(t[11]=o=>e.form.recurrence_setting=o)},null,8,["recurrence-setting"]),a(e.UploadEditor,{"image-list":e.form.image_list,"onUpdate:imageList":t[12]||(t[12]=o=>e.form.image_list=o),"files-list":e.form.files_list,"onUpdate:filesList":t[13]||(t[13]=o=>e.form.files_list=o)},null,8,["image-list","files-list"]),U(" Submit Button "),a(s,null,{default:n(()=>[a(L,{type:"primary",onClick:e.submitForm,loading:e.loading},{default:n(()=>[T($(d.$t("workOrder.actions.submit")),1)]),_:1},8,["loading"]),e.props.requestData?(g(),S(L,{key:0,onClick:t[14]||(t[14]=()=>e.emit("cancel")),type:"info"},{default:n(()=>t[15]||(t[15]=[T("Cancel")])),_:1,__:[15]})):U("v-if",!0)]),_:1})]),_:1},8,["model","rules"])])}const vo=ae(Le,[["render",Re],["__scopeId","data-v-6326481b"],["__file","/home/erikyu/dev/mes-maintenance-frontend/src/views/workOrder/components/NewWorkOrder.vue"]]);export{vo as default};
